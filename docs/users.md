# Пользователи (Users)

## Обзор

Модуль управления пользовательскими профилями. Все пользователи системы (владельцы, консультанты, администраторы) хранятся в одной таблице с разделением по ролям.

## Структура данных

### User (Пользователь)

```go
type User struct {
    ID           uint      // Уникальный идентификатор
    Name         string    // Имя пользователя
    Email        string    // Email (уникальный)
    PasswordHash string    // Хеш пароля (bcrypt)
    Role         UserRole  // Роль: owner, consultant, admin
    CreatedAt    time.Time // Дата регистрации
    UpdatedAt    time.Time // Дата обновления профиля
}

type UserRole string

const (
    RoleOwner      UserRole = "owner"
    RoleConsultant UserRole = "consultant"
    RoleAdmin      UserRole = "admin"
)
```

## Бизнес-процессы

### 1. Получение списка пользователей

**Endpoint**: `GET /api/v1/users`

**Права доступа**: Admin only

**Бизнес-логика**:
1. Только администраторы могут просматривать список всех пользователей
2. Возвращается список без паролей
3. Можно использовать для админ-панели

**Пример ответа**:
```json
[
  {
    "id": 1,
    "name": "Иван Петров",
    "email": "ivan@example.com",
    "role": "owner",
    "created_at": "2025-11-01T10:00:00Z"
  },
  {
    "id": 5,
    "name": "Алексей Сидоров",
    "email": "alex@example.com",
    "role": "consultant",
    "created_at": "2025-11-15T14:30:00Z"
  }
]
```

**Ошибки**:
- 403 - Доступ запрещён (не админ)

### 2. Получение пользователя по ID

**Endpoint**: `GET /api/v1/users/:id`

**Права доступа**: 
- Любой пользователь может получить **свой** профиль
- Admin может получить профиль **любого** пользователя

**Бизнес-логика**:
1. Извлекается ID из URL
2. Проверяется доступ:
   - Если `user_id == id` OR `role == admin` → разрешено
   - Иначе → 403 Forbidden
3. Возвращается профиль без пароля

**Пример ответа**:
```json
{
  "id": 1,
  "name": "Иван Петров",
  "email": "ivan@example.com",
  "role": "owner",
  "created_at": "2025-11-01T10:00:00Z",
  "updated_at": "2025-11-23T09:00:00Z"
}
```

**Ошибки**:
- 403 - Попытка получить чужой профиль
- 404 - Пользователь не найден

### 3. Обновление пользователя

**Endpoint**: `PUT /api/v1/users/:id`

**Права доступа**:
- Пользователь может обновить **свой** профиль
- Admin может обновить **любой** профиль

**Бизнес-логика**:
1. Проверяется доступ (свой профиль или админ)
2. Можно обновить:
   - `name` - Имя
   - `email` - Email (с проверкой уникальности)
   - `password` - Новый пароль (будет захеширован)
3. Поле `role` может менять **только админ**
4. Все поля опциональные (частичное обновление)

**Валидация**:
- `email`: должен быть уникальным
- `password`: минимум 6 символов (если указан)
- `name`: не пустое, если указано

**Пример запроса** (обычный пользователь):
```json
{
  "name": "Иван Петрович Петров",
  "email": "ivan.new@example.com"
}
```

**Пример запроса** (админ меняет роль):
```json
{
  "role": "admin"
}
```

**Пример ответа**:
```json
{
  "id": 1,
  "name": "Иван Петрович Петров",
  "email": "ivan.new@example.com",
  "role": "owner",
  "updated_at": "2025-11-23T10:30:00Z"
}
```

**Ошибки**:
- 403 - Попытка обновить чужой профиль
- 403 - Не-админ пытается изменить роль
- 409 - Email уже занят другим пользователем
- 400 - Неверный формат данных

### 4. Удаление пользователя

**Endpoint**: `DELETE /api/v1/users/:id`

**Права доступа**: Admin only

**Бизнес-логика**:
1. Только админ может удалять пользователей
2. При удалении пользователя:
   - **Owner**: Каскадно удаляются все собаки и связанные данные
   - **Consultant**: Удаляются профиль, доступы, заметки
3. Возвращается 204 No Content

**Каскадные удаления**:

При удалении **Owner**:
```
users (owner) 
  → dogs 
    → events (SET NULL)
    → consultant_access
    → consultant_notes
```

При удалении **Consultant**:
```
users (consultant)
  → consultant_profiles
  → consultant_access
  → consultant_notes
  → invites
```

**Ошибки**:
- 403 - Не админ
- 404 - Пользователь не найден

## Роли пользователей

### Owner (Владелец)

**Возможности**:
- Создавать и управлять своими собаками
- Создавать события для своих собак
- Приглашать консультантов
- Просматривать свой профиль

**Ограничения**:
- Не видит собак других владельцев
- Не видит заметки консультантов
- Не может получать доступ к чужим собакам

### Consultant (Консультант)

**Возможности**:
- Создавать и редактировать профиль консультанта
- Просматривать собак с предоставленным доступом
- Создавать события для собак клиентов
- Создавать и редактировать заметки о собаках
- Принимать приглашения от владельцев

**Ограничения**:
- Не может создавать собак
- Не может редактировать или удалять собак
- Не может удалять события
- Видит только собак, к которым есть доступ

### Admin (Администратор)

**Возможности**:
- Полный доступ ко всем данным
- Управление пользователями
- Изменение ролей
- Удаление любых записей
- Просмотр всех собак, событий, заметок

**Использование**: Обслуживание системы, модерация

## Контроль доступа (RBAC)

### Таблица прав доступа

| Операция | Владелец своего профиля | Чужой профиль | Admin |
|----------|------------------------|---------------|-------|
| Список пользователей | ❌ | ❌ | ✅ |
| Получить профиль | ✅ Свой | ❌ | ✅ Любой |
| Обновить профиль | ✅ Свой | ❌ | ✅ Любой |
| Обновить роль | ❌ | ❌ | ✅ |
| Удалить профиль | ❌ | ❌ | ✅ |

### Смена роли

Только администраторы могут менять роли пользователей:

```go
// В UserService
func (s *userService) UpdateUser(id, requestUserID uint, role UserRole, req *UpdateUserRequest) error {
    // Проверка: менять роль может только админ
    if req.Role != nil && role != RoleAdmin {
        return errors.New("only admins can change roles")
    }
    
    // Остальная логика обновления
}
```

## Безопасность паролей

### Хеширование

При создании/обновлении пароля:
```go
hashedPassword, err := bcrypt.GenerateFromPassword([]byte(password), 10)
```

- Алгоритм: bcrypt
- Cost factor: 10
- Соль генерируется автоматически

### Хранение

В БД хранится только хеш пароля:
```sql
password_hash VARCHAR(255) NOT NULL
```

Исходный пароль **никогда** не сохраняется и не возвращается в API.

## База данных

### Схема таблицы

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('owner', 'consultant', 'admin')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

### Индексы
- `idx_users_email` - для быстрого поиска по email (вход)
- `idx_users_role` - для фильтрации по роли

### Constraints
- `email UNIQUE` - предотвращение дублирования email
- `role CHECK` - валидация роли на уровне БД

## Примеры использования

### Просмотр и обновление своего профиля

```bash
# Получить свой профиль
curl -X GET http://localhost:8080/api/v1/users/1 \
  -H "Authorization: Bearer $TOKEN"

# Обновить имя
curl -X PUT http://localhost:8080/api/v1/users/1 \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Иван Петрович Петров"
  }'

# Сменить email
curl -X PUT http://localhost:8080/api/v1/users/1 \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "email": "ivan.new@example.com"
  }'

# Сменить пароль
curl -X PUT http://localhost:8080/api/v1/users/1 \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "password": "newSecurePassword123"
  }'
```

### Админ операции

```bash
# Получить список всех пользователей
curl -X GET http://localhost:8080/api/v1/users \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# Повысить пользователя до админа
curl -X PUT http://localhost:8080/api/v1/users/5 \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{
    "role": "admin"
  }'

# Удалить пользователя
curl -X DELETE http://localhost:8080/api/v1/users/5 \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

## Связь с другими модулями

### Для Owner
- [Собаки](./dogs.md) - владение собаками
- [События](./events.md) - создание событий
- [Консультанты](./consultants.md) - приглашение консультантов

### Для Consultant
- [Консультанты](./consultants.md) - профиль консультанта
- [Заметки](./consultant-notes.md) - профессиональные записи
- [События](./events.md) - создание событий для клиентов

## Бизнес-правила

1. **Уникальность email**: Один email = один аккаунт
2. **Неизменность ID**: ID пользователя нельзя изменить
3. **Защита роли**: Роль может менять только админ
4. **Безопасность пароля**: Пароли хешируются, исходные не сохраняются
5. **Каскадные удаления**: При удалении пользователя удаляются все связанные данные
6. **Самообслуживание**: Пользователи управляют своими профилями

## Связанные модули

- [Аутентификация](./auth.md) - регистрация и вход
- [Собаки](./dogs.md) - владение и доступ
- [Консультанты](./consultants.md) - расширенный профиль
