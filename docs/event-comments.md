# Комментарии к событиям (Event Comments)

## Обзор

Модуль для обсуждения событий между владельцами собак и консультантами. Позволяет оставлять комментарии к событиям с поддержкой Markdown-форматирования.

## Структура данных

### EventComment (Комментарий к событию)

```go
type EventComment struct {
    ID        uint      // Уникальный идентификатор
    EventID   uint      // ID события
    Event     *Event    // Связь с событием
    UserID    uint      // ID автора комментария
    User      *User     // Связь с пользователем
    Content   string    // Содержимое (Markdown)
    CreatedAt time.Time // Дата создания
    UpdatedAt time.Time // Дата обновления
}
```

## Бизнес-процессы

### 1. Создание комментария

**Endpoint**: `POST /api/v1/events/:id/comments`

**Права доступа**: Owner (своих собак), Consultant (с доступом), Admin

**Бизнес-логика**:
1. Пользователь добавляет комментарий к событию
2. Система проверяет доступ к событию через собаку:
   - Владелец собаки → доступ разрешён
   - Консультант с доступом к собаке → доступ разрешён
   - Админ → доступ разрешён
3. Комментарий создаётся с текущим временем
4. Автор сохраняется автоматически

**Валидация**:
- `event_id`: берётся из URL (обязательно)
- `content`: обязательное поле, Markdown текст

**Пример запроса**:
```json
{
  "content": "# Отличная прогулка!\n\nСобака была очень активной сегодня."
}
```

**Пример ответа**:
```json
{
  "id": 42,
  "event_id": 15,
  "user_id": 3,
  "content": "# Отличная прогулка!\n\nСобака была очень активной сегодня.",
  "created_at": "2025-11-23T14:00:00Z",
  "updated_at": "2025-11-23T14:00:00Z"
}
```

**Ошибки**:
- 403 - Нет доступа к событию (нет доступа к собаке)
- 404 - Событие не найдено
- 400 - Невалидные данные

### 2. Получение списка комментариев события

**Endpoint**: `GET /api/v1/events/:id/comments`

**Права доступа**: Authenticated с доступом к событию

**Бизнес-логика**:
1. Проверяется доступ к событию (через собаку)
2. Загружаются все комментарии события
3. Комментарии упорядочены по дате создания (от старых к новым)
4. Для каждого комментария включается информация об авторе

**Пример ответа**:
```json
{
  "comments": [
    {
      "id": 42,
      "event_id": 15,
      "user_id": 3,
      "user_name": "Иван Петров",
      "user_role": "owner",
      "content": "# Отличная прогулка!...",
      "created_at": "2025-11-23T14:00:00Z",
      "updated_at": "2025-11-23T14:00:00Z"
    },
    {
      "id": 43,
      "event_id": 15,
      "user_id": 5,
      "user_name": "Алексей Иванов",
      "user_role": "consultant",
      "content": "## Профессиональная оценка...",
      "created_at": "2025-11-23T15:30:00Z",
      "updated_at": "2025-11-23T15:30:00Z"
    }
  ],
  "count": 2
}
```

**Ошибки**:
- 403 - Нет доступа к событию

### 3. Получение комментария по ID

**Endpoint**: `GET /api/v1/event-comments/:id`

**Права доступа**: Authenticated с доступом к событию

**Бизнес-логика**:
1. Загружается комментарий по ID
2. Проверяется доступ к связанному событию
3. Возвращается комментарий с информацией об авторе

**Пример ответа**:
```json
{
  "id": 42,
  "event_id": 15,
  "user_id": 3,
  "user_name": "Иван Петров",
  "user_role": "owner",
  "content": "# Отличная прогулка!\n\nСобака была очень активной.",
  "created_at": "2025-11-23T14:00:00Z",
  "updated_at": "2025-11-23T14:00:00Z"
}
```

**Ошибки**:
- 404 - Комментарий не найден
- 403 - Нет доступа к событию

### 4. Обновление комментария

**Endpoint**: `PUT /api/v1/event-comments/:id`

**Права доступа**: Автор комментария или Admin

**Бизнес-логика**:
1. Находится комментарий по ID
2. Проверяется владение:
   - Автор комментария (`user_id == comment.user_id`)
   - Админ
3. Обновляется поле `content`
4. Поле `updated_at` обновляется автоматически

**Валидация**:
- `content`: обязательное поле

**Пример запроса**:
```json
{
  "content": "# Обновлено: Отличная прогулка!\n\nДобавил детали о поведении."
}
```

**Ошибки**:
- 404 - Комментарий не найден
- 403 - Попытка изменить чужой комментарий (не автор и не админ)
- 400 - Невалидные данные

### 5. Удаление комментария

**Endpoint**: `DELETE /api/v1/event-comments/:id`

**Права доступа**: Автор комментария или Admin

**Бизнес-логика**:
1. Находится комментарий по ID
2. Проверяется владение (автор или админ)
3. Комментарий удаляется безвозвратно
4. Возвращается 204 No Content

**Ошибки**:
- 404 - Комментарий не найден
- 403 - Попытка удалить чужой комментарий

## Контроль доступа (RBAC)

### Таблица прав

| Операция | Owner (своей собаки) | Consultant (с доступом) | Другой пользователь | Admin |
|----------|---------------------|------------------------|---------------------|-------|
| Создать комментарий | ✅ К событиям своих собак | ✅ К событиям собак с доступом | ❌ | ✅ К любым |
| Список комментариев | ✅ Своих собак | ✅ Собак с доступом | ❌ | ✅ Всех |
| Получить комментарий | ✅ Своих собак | ✅ Собак с доступом | ❌ | ✅ Любой |
| Обновить комментарий | ✅ Только свой | ✅ Только свой | ❌ | ✅ Любой |
| Удалить комментарий | ✅ Только свой | ✅ Только свой | ❌ | ✅ Любой |

### Проверка доступа к событию

Цепочка проверок:
```
User → Event → Dog → Owner/ConsultantAccess
```

**Для Owner**:
```go
// Получить событие
event, _ := eventRepo.GetByID(eventID)

// Получить собаку
dog, _ := dogRepo.GetByID(event.DogID)

// Проверить владение
if dog.OwnerID == userID {
    // Доступ разрешён
}
```

**Для Consultant**:
```go
// Получить событие
event, _ := eventRepo.GetByID(eventID)

// Проверить доступ к собаке
hasAccess, _ := dogRepo.HasConsultantAccess(userID, event.DogID)
if hasAccess {
    // Доступ разрешён
}
```

## Markdown поддержка

### Сохранение
- Комментарии сохраняются как plain text в формате Markdown
- Никакой обработки на бэкенде
- Фронтенд отвечает за рендеринг

### Примеры использования Markdown

#### Владелец документирует событие
```markdown
# Прогулка в парке

## Что делали:
- Игра с мячом
- Тренировка команд
- Общение с другими собаками

Собака была **очень активной**!
```

#### Консультант даёт обратную связь
```markdown
## Профессиональная оценка

### Наблюдения:
1. Хорошая концентрация
2. Позитивная реакция на команды
3. Нужно больше социализации

### Рекомендации:
- Продолжить регулярные прогулки
- Увеличить время тренировок до 20мин
- `Команда "рядом"` требует закрепления
```

#### Обсуждение между владельцем и консультантом
```markdown
> Цитата из предыдущего комментария

Согласен с оценкой. Буду работать над **социализацией**.

**Вопрос:** Сколько раз в неделю рекомендуете тренировки?
```

## База данных

### Схема таблицы

```sql
CREATE TABLE event_comments (
    id SERIAL PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id),
    content TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_event_comments_event_id ON event_comments(event_id);
CREATE INDEX idx_event_comments_user_id ON event_comments(user_id);
CREATE INDEX idx_event_comments_created_at ON event_comments(created_at);
```

### Индексы
- `idx_event_comments_event_id` - для загрузки комментариев события
- `idx_event_comments_user_id` - для фильтрации по автору
- `idx_event_comments_created_at` - для сортировки

### Каскадные операции
- `ON DELETE CASCADE` - при удалении события удаляются все комментарии

## Примеры использования

### Сценарий: Обсуждение тренировки

```bash
# 1. Владелец создаёт событие о тренировке
curl -X POST http://localhost:8080/api/v1/events \
  -H "Authorization: Bearer $OWNER_TOKEN" \
  -d '{
    "dog_id": 1,
    "type": "training",
    "note": "Первая тренировка",
    "at": "2025-11-23T10:00:00Z"
  }'
# Response: {"id": 15, ...}

# 2. Консультант комментирует событие
curl -X POST http://localhost:8080/api/v1/events/15/comments \
  -H "Authorization: Bearer $CONSULTANT_TOKEN" \
  -d '{
    "content": "## Отчёт о тренировке\n\n- Собака освоила \"сидеть\"\n- Рекомендую продолжить"
  }'

# 3. Владелец отвечает
curl -X POST http://localhost:8080/api/v1/events/15/comments \
  -H "Authorization: Bearer $OWNER_TOKEN" \
  -d '{
    "content": "Спасибо за обратную связь! Буду закреплять команду."
  }'

# 4. Получить все комментарии к событию
curl -X GET http://localhost:8080/api/v1/events/15/comments \
  -H "Authorization: Bearer $OWNER_TOKEN"

# 5. Консультант редактирует свой комментарий
curl -X PUT http://localhost:8080/api/v1/event-comments/42 \
  -H "Authorization: Bearer $CONSULTANT_TOKEN" \
  -d '{
    "content": "## Обновлённый отчёт\n\nДобавлено: отличный прогресс!"
  }'
```

### Сценарий: Ветеринарный осмотр

```bash
# Событие: визит к ветеринару
# Владелец создаёт комментарий
{
  "content": "# Ветеринарный осмотр\n\nВсё в порядке, сделали прививку."
}

# Консультант (ветеринар) добавляет деталі
{
  "content": "## Медицинская карта\n\n**Вес:** 25кг\n**Вакцина:** Nobivac DHPPi\n\n**Следующий визит:** через 6 месяцев"
}
```

## Сценарии использования

### 1. Владелец и консультант обсуждают прогресс
- Владелец создаёт событие "Прогулка"
- Консультант комментирует наблюдения
- Владелец задаёт вопросы
- Консультант даёт рекомендации

### 2. Совместная работа над проблемой
- Событие: "Собака лает на прохожих"
- Владелец описывает ситуацию
- Консультант предлагает план действий
- Владелец отчитывается о результатах
- Консультант корректирует подход

### 3. Документирование лечения
- Событие: "Приём лекарств"
- Владелец отмечает время приёма
- Ветеринар комментирует дозировку
- Владелец сообщает о побочных эффектах
- Ветеринар корректирует назначения

## Отличия от заметок консультантов

| Характеристика | Event Comments | Consultant Notes |
|----------------|---------------|------------------|
| **Привязка** | К событию | К собаке |
| **Видимость** | Все с доступом к событию | Только автор + админ |
| **Назначение** | Обсуждение конкретного события | Профессиональная документация |
| **Авторы** | Владелец + консультанты | Только консультанты |
| **Контекст** | Публичное обсуждение | Приватные записи |

**Когда использовать комментарии:**
- Обсуждение конкретной прогулки, тренировки, визита к вету
- Обмен наблюдениями между владельцем и консультантом
- Документирование совместных решений

**Когда использовать заметки:**
- Профессиональный анализ поведения
- Долгосрочное планирование тренировок
- Медицинская карта (для ветеринаров)
- Внутренние наблюдения консультанта

## Бизнес-правила

1. **Доступ через событие**: Право комментировать определяется доступом к событию (через собаку)
2. **Только автор**: Редактировать/удалять может только автор комментария (или админ)
3. **Публичность**: Все комментарии видны всем, кто имеет доступ к событию
4. **Хронология**: Комментарии упорядочены от старых к новым (история обсуждения)
5. **Каскад**: При удалении события удаляются все комментарии
6. **Необратимость**: Удалённые комментарии не восстанавливаются
7. **Атрибуция**: Каждый комментарий привязан к автору

## Связанные модули

- [События](./events.md) - родительская сущность для комментариев
- [Собаки](./dogs.md) - основа для проверки доступа
- [Консультанты](./consultants.md) - система доступа консультантов
- [Заметки консультантов](./consultant-notes.md) - приватные записи (в отличие от публичных комментариев)
- [Пользователи](./users.md) - авторы комментариев
